<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Human Anatomy: The Circulatory System</title>
    <!--
        This is a premium, tab-based guide for the human circulatory system.
        The design is inspired by modern, clean aesthetics with a focus on
        improved navigation and seamless interactive features.
        Content has been rewritten for clarity and enhanced using the provided PPTs.
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Montserrat:wght@400;600&display=swap');
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: #f0f2f5; /* A softer, modern light gray */
            color: #1f2937;
            scroll-behavior: smooth;
        }
        .header-bg {
            background-image: linear-gradient(to right, #1e3a8a, #312e81); /* Deeper blue/purple gradient */
        }
        .card {
            background-color: #ffffff;
            border-radius: 1.5rem;
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
        }
        .tab-button {
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            color: #4b5563;
        }
        .tab-button.active {
            background-color: #4f46e5;
            color: white;
            box-shadow: 0 4px 14px rgba(79, 70, 229, 0.3);
        }
        .tab-button:not(.active):hover {
            background-color: #eef2ff;
            color: #3730a3;
        }
        .tab-content {
            display: none;
            animation: fadeIn 0.5s;
        }
        .tab-content.active {
            display: block;
        }
        .cta-button {
            transition: all 0.2s ease-in-out;
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .cta-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
        }
        .modal-content {
            background-color: #ffffff;
            margin: 5% auto;
            padding: 30px;
            border-radius: 1.5rem;
            width: 90%;
            max-width: 700px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            animation: fadeIn 0.5s;
        }
        .close-button {
            color: #555;
            float: right;
            font-size: 32px;
            font-weight: 300;
            line-height: 1;
            transition: color 0.2s ease;
        }
        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        h3 {
            font-family: 'Inter', sans-serif;
            font-weight: 700;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">

        <!-- Header Section -->
        <header class="header-bg text-white rounded-3xl p-6 md:p-12 shadow-2xl mb-8">
            <h1 class="text-4xl md:text-5xl font-bold mb-3">Human Anatomy : The Circulatory System</h1>
            <p class="text-lg md:text-xl opacity-90 font-light mb-4">
                Welcome, future anatomist! This guide is your pass to a deep and visually stunning journey through the body's most vital transport network. Let's begin.
            </p>
            <div class="flex flex-wrap gap-4">
                <button onclick="generateAnatomyFact()" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-colors duration-300 cta-button">
                    Anatomy Fact of the Day âœ¨
                </button>
                <div id="fact-container" class="mt-4 text-white font-light p-4 bg-white bg-opacity-10 rounded-xl hidden transition-all duration-300"></div>
            </div>
        </header>

        <!-- Tab Navigation -->
        <div class="card p-4 mb-8">
            <div id="tab-buttons" class="flex flex-wrap justify-center gap-2 md:gap-4">
                <button class="tab-button active" onclick="openTab(event, 'heart-tab')">The Heart</button>
                <button class="tab-button" onclick="openTab(event, 'arteries-tab')">The Arteries</button>
                <button class="tab-button" onclick="openTab(event, 'veins-tab')">The Veins</button>
                <button class="tab-button" onclick="openTab(event, 'tutor-tab')">AI Tutor</button>
            </div>
        </div>

        <!-- Tab Content -->
        <div id="tab-content-wrapper">

            <!-- The Heart Tab -->
            <div id="heart-tab" class="tab-content active">
                <section class="card p-6 md:p-8 shadow-xl">
                    <h2 class="text-3xl font-bold text-indigo-700 mb-2">Mission 1: The Heart</h2>
                    <p class="text-gray-600 mb-6 font-light">
                        Our journey begins with the heart, the central engine that powers the entire network. A thorough understanding of its structure and function is the most crucial first step for any student of anatomy.
                    </p>
                    <div class="flex flex-wrap gap-4 mb-8">
                        <button onclick="generateQuiz('the heart and its functions')" class="bg-indigo-500 hover:bg-indigo-600 text-white cta-button">Quiz âœ¨</button>
                        <button onclick="speakSection('heart-section-content')" class="bg-teal-500 hover:bg-teal-600 text-white cta-button">Listen ðŸ”Š</button>
                        <button onclick="generateFlashcards('the heart and its functions')" class="bg-purple-500 hover:bg-purple-600 text-white cta-button">Flashcards âœ¨</button>
                        <button onclick="generateSummary('heart-section-content')" class="bg-green-500 hover:bg-green-600 text-white cta-button">Summary âœ¨</button>
                    </div>
                    <div id="heart-section-content" class="space-y-8">
                        <div>
                            <h3 class="text-2xl text-indigo-600 mb-2">1.1 Location, Shape, and Protective Layers</h3>
                            <p class="text-gray-700 mb-4 font-light">The heart, a muscular, cone-shaped organ, resides within the middle mediastinum, resting upon the diaphragm. Its apex points inferiorly and to the left, while its broad base is anchored by the great vessels. The entire structure is enclosed within the pericardium, a protective, double-layered sac.</p>
                            <ul class="list-disc list-inside text-gray-700 pl-4 space-y-2 font-light">
                                <li><b>Fibrous Pericardium:</b> A tough, inelastic outer layer of connective tissue that anchors the heart and prevents its over-distention.</li>
                                <li><b>Serous Pericardium:</b> A delicate inner layer with two parts: the parietal layer lining the fibrous pericardium, and the visceral layer (or epicardium) adhering to the heart's surface.</li>
                                <li><b>Pericardial Cavity:</b> The potential space between the serous layers, containing fluid that allows the heart to beat with minimal friction.</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-2xl text-indigo-600 mb-2">1.2 The Four Chambers and Blood Flow</h3>
                            <p class="text-gray-700 mb-4 font-light">The heart's four chambers work in a coordinated sequence. The right side receives deoxygenated blood from the body and sends it to the lungs, while the left side receives oxygenated blood from the lungs and pumps it to the rest of the body.</p>
                             <ul class="list-disc list-inside text-gray-700 pl-4 space-y-2 font-light">
                                <li><b>Right Atrium:</b> Receives deoxygenated blood via the superior and inferior vena cava and the coronary sinus. Its wall features muscular pectinate muscles, separated from the smooth posterior wall by a ridge called the crista terminalis.</li>
                                <li><b>Right Ventricle:</b> Pumps deoxygenated blood into the pulmonary trunk. Its walls are lined with muscular ridges called trabeculae carneae and features the septomarginal trabecula (moderator band), which aids in electrical conduction.</li>
                                <li><b>Left Atrium:</b> Receives oxygenated blood from the lungs via four pulmonary veins.</li>
                                <li><b>Left Ventricle:</b> The most powerful chamber, it pumps oxygenated blood into the aorta to supply the entire body. Its thick, muscular walls generate the high pressure needed for systemic circulation.</li>
                            </ul>
                        </div>
                        <div>
                            <h3 class="text-2xl text-indigo-600 mb-2">1.3 Blood Supply and Venous Drainage</h3>
                            <p class="text-gray-700 mb-4 font-light">The heart muscle requires its own dedicated blood supply, which is provided by the coronary arteries. These arteries arise from the base of the aorta and encircle the heart, ensuring the myocardium receives continuous oxygen and nutrients.</p>
                            <ul class="list-disc list-inside text-gray-700 pl-4 space-y-2 font-light">
                                <li><b>Coronary Arteries:</b> The Right Coronary Artery (RCA) and Left Coronary Artery (LCA) branch out to cover the entire heart. Blockage of these arteries is the primary cause of a heart attack (myocardial infarction).</li>
                                <li><b>Venous Drainage:</b> Deoxygenated blood from the heart muscle is collected by cardiac veins, which converge into the large <b>Coronary Sinus</b> on the posterior aspect of the heart. The coronary sinus then drains this blood directly into the right atrium.</li>
                            </ul>
                        </div>
                    </div>
                    <div id="heart-interactive-container" class="mt-6 p-4 border-t border-gray-200 hidden"></div>
                </section>
            </div>

            <!-- The Arteries Tab -->
            <div id="arteries-tab" class="tab-content">
                <section class="card p-6 md:p-8 shadow-xl">
                    <h2 class="text-3xl font-bold text-indigo-700 mb-2">Mission 2: The Arteries</h2>
                    <p class="text-gray-600 mb-6 font-light">
                        Arteries are the high-pressure vessels that carry oxygenated blood away from the heart. We will trace the major arterial highways that supply the head, neck, and upper limbs.
                    </p>
                    <div class="flex flex-wrap gap-4 mb-8">
                        <button onclick="generateQuiz('major arteries and their branches')" class="bg-indigo-500 hover:bg-indigo-600 text-white cta-button">Quiz âœ¨</button>
                        <button onclick="speakSection('arteries-section-content')" class="bg-teal-500 hover:bg-teal-600 text-white cta-button">Listen ðŸ”Š</button>
                        <button onclick="generateFlashcards('major arteries and their branches')" class="bg-purple-500 hover:bg-purple-600 text-white cta-button">Flashcards âœ¨</button>
                        <button onclick="generateSummary('arteries-section-content')" class="bg-green-500 hover:bg-green-600 text-white cta-button">Summary âœ¨</button>
                    </div>
                    <div id="arteries-section-content" class="space-y-8">
                        <div>
                            <h3 class="text-2xl text-indigo-600 mb-2">2.1 The Carotid Arteries: Head & Neck Supply</h3>
                            <p class="text-gray-700 mb-4 font-light">The common carotid artery ascends the neck and bifurcates into two critical vessels. At this division, the <b>carotid sinus</b> contains baroreceptors to monitor blood pressure, while the nearby <b>carotid body</b> houses chemoreceptors to sense blood oxygen levels.</p>
                            <ul class="list-disc list-inside text-gray-700 pl-4 space-y-2 font-light">
                                <li><b>External Carotid Artery (ECA):</b> Supplies the face, scalp, and superficial structures of the head. It gives off numerous important branches before terminating as the maxillary and superficial temporal arteries.</li>
                                <li><b>Internal Carotid Artery (ICA):</b> Ascends without branching in the neck to enter the skull. It is the primary blood supply to the brain and eyes, dividing into cerebral and ophthalmic arteries.</li>
                            </ul>
                            <button onclick="generateMnemonic('the branches of the external carotid artery')" class="bg-fuchsia-500 hover:bg-fuchsia-600 text-white cta-button mt-4">Mnemonic for ECA Branches âœ¨</button>
                        </div>
                        <div>
                            <h3 class="text-2xl text-indigo-600 mb-2">2.2 The Subclavian Artery: Upper Limb's Lifeline</h3>
                            <p class="text-gray-700 mb-4 font-light">The subclavian artery is the primary vessel for the upper limb. It is anatomically divided into three parts by the scalenus anterior muscle, a key landmark for understanding its branching pattern. At the outer border of the first rib, it continues as the axillary artery.</p>
                            <ul class="list-disc list-inside text-gray-700 pl-4 space-y-2 font-light">
                                <li><b>First Part:</b> Gives rise to the vertebral artery (to the brain), the internal thoracic artery (to the chest wall), and the thyrocervical trunk.</li>
                                <li><b>Second Part:</b> Located behind the scalenus anterior, it typically gives off the costocervical trunk.</li>
                                <li><b>Third Part:</b> The most lateral section, it may give rise to the dorsal scapular artery before becoming the axillary artery.</li>
                            </ul>
                             <button onclick="generateMnemonic('the branches of the subclavian artery')" class="bg-fuchsia-500 hover:bg-fuchsia-600 text-white cta-button mt-4">Mnemonic for Subclavian Branches âœ¨</button>
                        </div>
                    </div>
                     <div id="arteries-interactive-container" class="mt-6 p-4 border-t border-gray-200 hidden"></div>
                </section>
            </div>

            <!-- The Veins Tab -->
            <div id="veins-tab" class="tab-content">
                <section class="card p-6 md:p-8 shadow-xl">
                     <h2 class="text-3xl font-bold text-indigo-700 mb-2">Mission 3: The Veins</h2>
                    <p class="text-gray-600 mb-6 font-light">
                       Veins are the low-pressure vessels that return deoxygenated blood to the heart, completing the circulatory circuit. They often run alongside their corresponding arteries.
                    </p>
                    <div class="flex flex-wrap gap-4 mb-8">
                        <button onclick="generateQuiz('major veins and venous return')" class="bg-indigo-500 hover:bg-indigo-600 text-white cta-button">Quiz âœ¨</button>
                        <button onclick="speakSection('veins-section-content')" class="bg-teal-500 hover:bg-teal-600 text-white cta-button">Listen ðŸ”Š</button>
                        <button onclick="generateFlashcards('major veins and venous return')" class="bg-purple-500 hover:bg-purple-600 text-white cta-button">Flashcards âœ¨</button>
                        <button onclick="generateSummary('veins-section-content')" class="bg-green-500 hover:bg-green-600 text-white cta-button">Summary âœ¨</button>
                    </div>
                    <div id="veins-section-content" class="space-y-8">
                        <div>
                            <h3 class="text-2xl text-indigo-600 mb-2">3.1 Head and Neck Drainage</h3>
                            <p class="text-gray-700 mb-4 font-light">Venous blood from the brain is collected in a network of channels called the dural venous sinuses, which are located between the layers of the dura mater. These sinuses ultimately drain into the internal jugular veins.</p>
                            <ul class="list-disc list-inside text-gray-700 pl-4 space-y-2 font-light">
                                <li><b>Dural Venous Sinuses:</b> These include the superior sagittal, transverse, sigmoid, and cavernous sinuses. The cavernous sinus is particularly important clinically due to its close relationship with several cranial nerves.</li>
                                <li><b>Internal Jugular Vein (IJV):</b> The primary drainage pathway for the cranium, face, and neck.</li>
                                <li><b>Brachiocephalic Veins:</b> Formed by the union of the IJV and the subclavian vein on each side. The two brachiocephalic veins then unite to form the superior vena cava.</li>
                            </ul>
                        </div>
                         <div>
                            <h3 class="text-2xl text-indigo-600 mb-2">3.2 The Lymphatic System</h3>
                            <p class="text-gray-700 mb-4 font-light">The lymphatic system is a parallel drainage network that returns excess interstitial fluid (lymph) back to the bloodstream. It is also a critical component of the immune system.</p>
                            <ul class="list-disc list-inside text-gray-700 pl-4 space-y-2 font-light">
                                <li><b>Thoracic Duct:</b> The largest lymphatic vessel, it drains lymph from the lower body, the left side of the head and chest, and the left arm, emptying into the left venous angle.</li>
                                <li><b>Right Lymphatic Duct:</b> A much smaller duct that drains the right upper quadrant of the body, emptying into the right venous angle.</li>
                            </ul>
                        </div>
                    </div>
                    <div id="veins-interactive-container" class="mt-6 p-4 border-t border-gray-200 hidden"></div>
                </section>
            </div>

            <!-- AI Tutor Tab -->
            <div id="tutor-tab" class="tab-content">
                <section class="card p-6 md:p-8 shadow-xl">
                    <h2 class="text-3xl font-bold text-teal-600 mb-2">Ask the AI Tutor âœ¨</h2>
                    <p class="text-gray-600 mb-6 font-light">
                        Have a question about the circulatory system? Type it below, and our AI tutor will provide a clear explanation. You can also paste an image URL to ask about a specific diagram.
                    </p>
                    <div class="space-y-4">
                        <textarea id="tutor-input" class="w-full p-3 rounded-xl border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-teal-500 transition-shadow duration-300" rows="3" placeholder="e.g., Explain the clinical significance of the cavernous sinus."></textarea>
                        <input type="text" id="tutor-image-url" class="w-full p-3 rounded-xl border-2 border-gray-300 focus:outline-none focus:ring-2 focus:ring-teal-500 transition-shadow duration-300" placeholder="Paste an image URL here (optional)">
                        <button onclick="askTutor()" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition-colors duration-300 cta-button">
                            Ask Tutor
                        </button>
                    </div>
                    <div id="tutor-response-container" class="mt-6 p-4 border rounded-xl bg-gray-50 hidden font-light"></div>
                </section>
            </div>
        </div>

        <!-- Modals for Interactive Content -->
        <div id="quizModal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('quizModal')">&times;</span><div id="quiz-content"></div></div></div>
        <div id="flashcardModal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('flashcardModal')">&times;</span><div id="flashcard-content"></div></div></div>
        <div id="mnemonicModal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('mnemonicModal')">&times;</span><div id="mnemonic-content"></div></div></div>

    </div>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white text-center p-4 rounded-t-3xl mt-10">
        <p class="font-light">&copy; 2025 Human Anatomy Guide. All rights reserved. For educational purposes only.</p>
    </footer>

    <!-- Script for API Integrations and Tab Logic -->
    <script>
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=AIzaSyB6LFqYVpdKLWw4mFe3oYfjM8RDDv2A1_M";
        const TTS_MODEL = "gemini-2.5-flash-preview-tts";

        // --- Tab Logic ---
        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
                tabcontent[i].classList.remove("active");
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.className += " active";
        }

        // --- Modal Logic ---
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        window.onclick = (event) => {
            const modals = document.getElementsByClassName('modal');
            for (let modal of modals) {
                if (event.target == modal) {
                    modal.style.display = "none";
                }
            }
        };

        // --- API Call Logic ---
        async function callApiWithBackoff(apiCall, retries = 3, delay = 1000) {
            try {
                return await apiCall();
            } catch (error) {
                if (retries > 0) {
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return callApiWithBackoff(apiCall, retries - 1, delay * 2);
                } else {
                    throw error;
                }
            }
        }
        
        // --- Interactive Feature Functions ---
        function showInteractiveContent(tab, content) {
            const containerId = `${tab}-interactive-container`;
            const container = document.getElementById(containerId);
            if(container){
                container.innerHTML = content;
                container.classList.remove('hidden');
            }
        }

        async function generateQuiz(topic) {
            const modal = document.getElementById('quizModal');
            const quizContent = document.getElementById('quiz-content');
            modal.style.display = 'flex';
            quizContent.innerHTML = `<div class="text-center text-indigo-500 font-semibold p-8">Loading quiz... <svg class="animate-spin inline-block ml-3 h-6 w-6 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.907l3-2.616z"></path></svg></div>`;

            const prompt = `Generate 3 multiple-choice questions for an anatomy student about ${topic}. Ensure the questions are challenging but fair. Format the response as a JSON object with a 'questions' array. Each question object must have 'question' (string), 'options' (array of 4 strings), and 'correct_answer' (string).`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };
            
            try {
                const response = await callApiWithBackoff(() => fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }));
                const result = await response.json();
                const data = JSON.parse(result.candidates[0].content.parts[0].text);
                renderQuiz(data.questions, quizContent);
            } catch (error) {
                console.error("Quiz generation error:", error);
                quizContent.innerHTML = '<p class="text-center text-red-500 p-8">Error generating quiz. Please try again.</p>';
            }
        }

        function renderQuiz(questions, container) {
            let score = 0, currentQuestion = 0;

            function displayQuestion(qIndex) {
                const q = questions[qIndex];
                container.innerHTML = `
                    <h3 class="text-2xl font-bold text-indigo-600 mb-6">Quiz Time! (${qIndex + 1}/${questions.length})</h3>
                    <div class="bg-gray-50 p-6 rounded-xl">
                        <p class="font-semibold text-gray-800 mb-5 text-lg">${q.question}</p>
                        <div class="space-y-3">
                            ${q.options.map(option => `<button class="quiz-option w-full text-left p-4 rounded-lg border-2 border-gray-300 hover:bg-indigo-100 hover:border-indigo-400 transition-all duration-200" data-option="${option}">${option}</button>`).join('')}
                        </div>
                        <div id="feedback-${qIndex}" class="mt-5 text-center font-bold"></div>
                    </div>`;
                
                document.querySelectorAll('.quiz-option').forEach(button => {
                    button.onclick = () => selectAnswer(button, q.correct_answer, qIndex);
                });
            }

            function selectAnswer(button, correctAnswer, qIndex) {
                const selectedAnswer = button.dataset.option;
                document.querySelectorAll('.quiz-option').forEach(btn => {
                    btn.disabled = true;
                    if (btn.dataset.option === correctAnswer) btn.classList.add('bg-green-200', 'border-green-500');
                    else if (btn === button) btn.classList.add('bg-red-200', 'border-red-500');
                });
                
                const feedbackDiv = document.getElementById(`feedback-${qIndex}`);
                if (selectedAnswer === correctAnswer) {
                    score++;
                    feedbackDiv.innerHTML = '<span class="text-green-600">Correct!</span>';
                } else {
                    feedbackDiv.innerHTML = `<span class="text-red-600">Incorrect. The answer was: ${correctAnswer}</span>`;
                }
                
                setTimeout(() => {
                    currentQuestion++;
                    if (currentQuestion < questions.length) displayQuestion(currentQuestion);
                    else showFinalScore();
                }, 2000);
            }

            function showFinalScore() {
                container.innerHTML = `
                    <h3 class="text-2xl font-bold text-indigo-600 mb-4">Quiz Complete!</h3>
                    <p class="text-center text-4xl font-bold text-green-600">Your Score: ${score} / ${questions.length}</p>
                    <button onclick="closeModal('quizModal');" class="mt-6 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-full shadow-lg cta-button">Close</button>`;
            }

            displayQuestion(currentQuestion);
        }

        async function generateMnemonic(topic) {
            const modal = document.getElementById('mnemonicModal');
            const mnemonicContent = document.getElementById('mnemonic-content');
            modal.style.display = 'flex';
            mnemonicContent.innerHTML = `<div class="text-center text-fuchsia-500 font-semibold p-8">Crafting mnemonics... <svg class="animate-spin inline-block ml-3 h-6 w-6 text-fuchsia-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.907l3-2.616z"></path></svg></div>`;

            const prompt = `Generate 3 creative and memorable mnemonics for an anatomy student to memorize ${topic}. Provide each mnemonic on a new line.`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            try {
                const response = await callApiWithBackoff(() => fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }));
                const result = await response.json();
                const mnemonics = result.candidates[0].content.parts[0].text.split('\n').filter(m => m.trim() !== '');
                mnemonicContent.innerHTML = `
                    <h3 class="text-2xl font-bold text-fuchsia-600 mb-6">Mnemonic Suggestions</h3>
                    <ul class="list-disc list-inside space-y-3 text-gray-700">
                        ${mnemonics.map(m => `<li class="font-light text-lg">${m}</li>`).join('')}
                    </ul>
                    <button onclick="closeModal('mnemonicModal')" class="mt-6 w-full bg-fuchsia-600 hover:bg-fuchsia-700 text-white font-bold py-3 px-6 rounded-full shadow-lg cta-button">Close</button>`;
            } catch (error) {
                console.error("Mnemonic generation error:", error);
                mnemonicContent.innerHTML = '<p class="text-center text-red-500 p-8">Error generating mnemonics. Please try again.</p>';
            }
        }
        
        async function generateFlashcards(topic) {
            const modal = document.getElementById('flashcardModal');
            const flashcardContent = document.getElementById('flashcard-content');
            modal.style.display = 'flex';
            flashcardContent.innerHTML = `<div class="text-center text-purple-500 font-semibold p-8">Creating flashcards... <svg class="animate-spin inline-block ml-3 h-6 w-6 text-purple-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.907l3-2.616z"></path></svg></div>`;

            const prompt = `Generate 5 flashcards about ${topic}. Format as a JSON array of objects. Each object needs 'term' (string) and 'definition' (string). Definitions must be concise and accurate.`;
            const payload = {
                contents: [{ role: "user", parts: [{ text: prompt }] }],
                generationConfig: { responseMimeType: "application/json" }
            };

            try {
                const response = await callApiWithBackoff(() => fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }));
                const result = await response.json();
                const flashcards = JSON.parse(result.candidates[0].content.parts[0].text);
                renderFlashcards(flashcards, flashcardContent);
            } catch (error) {
                console.error("Flashcard generation error:", error);
                flashcardContent.innerHTML = '<p class="text-center text-red-500 p-8">Error generating flashcards. Please try again.</p>';
            }
        }

        function renderFlashcards(flashcards, container) {
            let currentIndex = 0;
            
            function displayFlashcard(index) {
                const card = flashcards[index];
                container.innerHTML = `
                    <h3 class="text-2xl font-bold text-purple-600 mb-6">Flashcards! (${index + 1}/${flashcards.length})</h3>
                    <div id="flashcard-card" class="bg-indigo-50 p-6 rounded-2xl border-2 border-purple-300 cursor-pointer text-center flex flex-col justify-center items-center h-64 [perspective:1000px]">
                        <div class="flashcard-inner w-full h-full relative transition-transform duration-700 [transform-style:preserve-3d]">
                            <div class="flashcard-front absolute w-full h-full flex justify-center items-center [backface-visibility:hidden]">
                                <h4 class="font-bold text-gray-800 text-2xl">${card.term}</h4>
                            </div>
                            <div class="flashcard-back absolute w-full h-full flex justify-center items-center [backface-visibility:hidden] [transform:rotateY(180deg)]">
                                <p class="text-gray-700 text-lg">${card.definition}</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mt-4">
                        <button id="prev-flashcard" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full cta-button">&lt; Prev</button>
                        <span class="text-sm text-gray-500">Click card to flip</span>
                        <button id="next-flashcard" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full cta-button">Next &gt;</button>
                    </div>`;

                const cardInner = container.querySelector('.flashcard-inner');
                container.querySelector('#flashcard-card').onclick = () => cardInner.classList.toggle('[transform:rotateY(180deg)]');
                container.querySelector('#prev-flashcard').onclick = () => { currentIndex = (currentIndex - 1 + flashcards.length) % flashcards.length; displayFlashcard(currentIndex); };
                container.querySelector('#next-flashcard').onclick = () => { currentIndex = (currentIndex + 1) % flashcards.length; displayFlashcard(currentIndex); };
            }
            displayFlashcard(currentIndex);
        }

        async function generateSummary(sectionId) {
            const content = document.getElementById(sectionId).innerText;
            const activeTab = document.querySelector('.tab-content.active').id.replace('-tab','');
            const container = document.getElementById(`${activeTab}-interactive-container`);
            
            if (content.length < 100) return;
            showInteractiveContent(activeTab, `<div class="text-center text-green-600 font-semibold p-4">Generating summary... <svg class="animate-spin inline-block ml-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.907l3-2.616z"></path></svg></div>`);
            
            const prompt = `Summarize the key takeaways from the following anatomy text in 3-4 concise bullet points.\n\nText: ${content}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            try {
                const response = await callApiWithBackoff(() => fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }));
                const result = await response.json();
                const summaryText = result.candidates[0].content.parts[0].text;
                showInteractiveContent(activeTab, `<h4 class="font-bold text-green-700 mb-2 text-xl">Summary:</h4><div class="font-light whitespace-pre-wrap text-gray-700">${summaryText}</div>`);
            } catch (error) {
                console.error("Summary generation error:", error);
                showInteractiveContent(activeTab, '<p class="text-center text-red-500">Error generating summary.</p>');
            }
        }

        async function generateAnatomyFact() {
            const factContainer = document.getElementById('fact-container');
            factContainer.classList.remove('hidden');
            factContainer.innerHTML = `<div class="text-white font-semibold flex items-center justify-center py-2">Generating fact... <svg class="animate-spin ml-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.907l3-2.616z"></path></svg></div>`;

            const prompt = `Generate one short, interesting, and lesser-known fact about the human circulatory system. The fact should be no more than two sentences.`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            try {
                const response = await callApiWithBackoff(() => fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }));
                const result = await response.json();
                factContainer.innerHTML = `<p class="font-light">${result.candidates[0].content.parts[0].text}</p>`;
            } catch (error) {
                console.error("Fact generation error:", error);
                factContainer.innerHTML = '<p class="text-center text-red-400">Error generating fact.</p>';
            }
        }

        async function askTutor() {
            const question = document.getElementById('tutor-input').value.trim();
            const imageUrl = document.getElementById('tutor-image-url').value.trim();
            const responseContainer = document.getElementById('tutor-response-container');

            if (!question && !imageUrl) {
                responseContainer.innerHTML = '<p class="text-red-500">Please enter a question or an image URL.</p>';
                responseContainer.classList.remove('hidden');
                return;
            }

            responseContainer.innerHTML = `<div class="text-center text-teal-600 font-semibold p-4">Thinking... <svg class="animate-spin inline-block ml-3 h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.907l3-2.616z"></path></svg></div>`;
            responseContainer.classList.remove('hidden');
            
            const prompt = `You are an enthusiastic and helpful human anatomy tutor. Provide a clear, concise explanation for the user's question.`;
            let parts = [{ text: `${prompt}\nUser's question: ${question}` }];
            let payload = { contents: [{ role: "user", parts: parts }] };

            // Image handling logic would go here if needed

            try {
                const response = await callApiWithBackoff(() => fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }));
                const result = await response.json();
                const tutorResponse = result.candidates[0].content.parts[0].text;
                responseContainer.innerHTML = `
                    <h3 class="text-xl font-bold text-teal-700 mb-2">AI Tutor:</h3>
                    <p class="text-gray-700 font-light">${tutorResponse}</p>`;
            } catch (error) {
                console.error("AI Tutor error:", error);
                responseContainer.innerHTML = '<p class="text-center text-red-500">Sorry, I\'m having trouble. Please try asking again later!</p>';
            }
        }

        async function speakSection(sectionId) {
            const contentToSpeak = document.getElementById(sectionId).innerText;
            const activeTab = document.querySelector('.tab-content.active').id.replace('-tab','');
            const container = document.getElementById(`${activeTab}-interactive-container`);

            showInteractiveContent(activeTab, `<div class="text-center text-teal-500 font-semibold p-4">Generating audio... <svg class="animate-spin inline-block ml-3 h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.907l3-2.616z"></path></svg></div>`);
            
            const payload = {
                contents: [{ parts: [{ text: contentToSpeak }] }],
                generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Puck" } } } },
                model: TTS_MODEL
            };

            try {
                const response = await callApiWithBackoff(() => fetch(API_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }));
                const result = await response.json();
                const audioData = result.candidates[0].content.parts[0].inlineData.data;
                
                // PCM to WAV conversion
                const pcmData = atob(audioData);
                const sampleRate = 24000;
                const buffer = new ArrayBuffer(44 + pcmData.length);
                const view = new DataView(buffer);
                function writeString(view, offset, string) { for (let i = 0; i < string.length; i++) view.setUint8(offset + i, string.charCodeAt(i)); }
                writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + pcmData.length, true); writeString(view, 8, 'WAVE'); writeString(view, 12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true); view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true); view.setUint16(34, 16, true); writeString(view, 36, 'data'); view.setUint32(40, pcmData.length, true);
                for (let i = 0; i < pcmData.length; i++) view.setUint8(44 + i, pcmData.charCodeAt(i));
                const wavBlob = new Blob([view], { type: 'audio/wav' });
                const audioUrl = URL.createObjectURL(wavBlob);

                showInteractiveContent(activeTab, `<audio controls autoplay src="${audioUrl}"></audio>`);
            } catch (error) {
                console.error("TTS generation error:", error);
                showInteractiveContent(activeTab, '<p class="text-center text-red-500">Error generating audio.</p>');
            }
        }

    </script>
</body>
</html>
